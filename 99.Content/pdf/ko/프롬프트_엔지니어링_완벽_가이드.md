# 프롬프트 엔지니어링 완벽 가이드: 기법과 최적화 전략

프롬프트 엔지니어링은 대규모 언어 모델(LLM)을 최대한 활용하기 위한 필수 기술입니다. 구글에서 발행한 '프롬프트 엔지니어링' 백서를 바탕으로 핵심 기법과 전략을 자세히 살펴보겠습니다.

## 프롬프트 엔지니어링이란?

프롬프트 엔지니어링은 LLM에게 최적의 응답을 얻기 위해 입력 텍스트를 설계하는 과정입니다. LLM의 작동 방식을 이해하는 것이 중요합니다:

```
LLM은 예측 엔진입니다. 모델은 순차적 텍스트를 입력으로 받아 학습 데이터를 기반으로 다음 토큰이 무엇이어야 할지 예측합니다.
이 과정이 반복되면서 이전에 예측된 토큰이 순차적 텍스트의 끝에 추가되고, 다음 토큰 예측에 사용됩니다.
```

프롬프트를 작성할 때는 LLM이 올바른 토큰 시퀀스를 예측하도록 설정하는 것이 목표입니다.

## LLM 출력 구성 최적화하기

### 1. 출력 길이 제어

출력 길이는 응답에서 생성할 토큰 수로 제어합니다. 더 많은 토큰을 생성할수록 더 많은 컴퓨팅 자원과 시간이 필요합니다.

```python
# Vertex AI API 예시
response = model.generate_content(
    prompt="주제에 대한 요약을 작성해주세요.",
    generation_config={"max_output_tokens": 100}  # 출력 토큰 수 제한
)
```

출력 길이 제한은 ReAct와 같은 프롬프팅 기법에서 특히 중요합니다. 모델이 원하는 응답 이후에도 불필요한 토큰을 계속 생성할 수 있기 때문입니다.

### 2. 샘플링 제어 매개변수

#### Temperature

Temperature는 토큰 선택의 무작위성을 제어합니다:

```python
# 낮은 temperature (결정적인 응답)
response = model.generate_content(
    prompt="2023년에 가장 인기 있었던 영화 5개를 나열해주세요.",
    generation_config={"temperature": 0.1}  # 사실적인 정보에 적합
)

# 높은 temperature (창의적인 응답)
response = model.generate_content(
    prompt="미래의 교통수단에 대한 창의적인 아이디어를 제시해주세요.",
    generation_config={"temperature": 0.9}  # 창의적 작업에 적합
)
```

- **Temperature = 0**: 항상 가장 높은 확률의 토큰 선택 (그리디 디코딩)
- **Temperature = 1+**: 토큰 선택이 더 무작위적으로 변함

#### Top-K와 Top-P

두 매개변수는 모델이 고려하는 토큰의 범위를 제한합니다:

```python
# Top-K 설정
response = model.generate_content(
    prompt="인공지능의 미래에 대한 에세이를 작성해주세요.",
    generation_config={
        "temperature": 0.7,
        "top_k": 40  # 상위 40개 토큰만 고려
    }
)

# Top-P 설정
response = model.generate_content(
    prompt="인공지능의 미래에 대한 에세이를 작성해주세요.",
    generation_config={
        "temperature": 0.7,
        "top_p": 0.95  # 누적 확률이 0.95를 넘지 않는 토큰만 고려
    }
)
```

- **Top-K**: 확률이 가장 높은 K개의 토큰만 고려합니다.
- **Top-P**: 누적 확률이 P 값을 초과하지 않는 토큰만 고려합니다.

일반적인 시작점으로는:

- **일반적인 태스크**: temperature 0.2, top-P 0.95, top-K 30
- **창의적인 출력**: temperature 0.9, top-P 0.99, top-K 40
- **사실적인 출력**: temperature 0.1, top-P 0.9, top-K 20
- **단일 정답이 있는 태스크(예: 수학 문제)**: temperature 0

### 반복 루프 버그(Repetition Loop Bug) 방지

높거나 낮은 temperature 설정에서 모델이 동일한 단어나 구문을 반복적으로 생성하는 '반복 루프 버그'가 발생할 수 있습니다. 이를 방지하려면 temperature, top-K, top-P 값을 조정하여 결정론과 무작위성 사이의 균형을 찾아야 합니다.

## 주요 프롬프트 기법

### 1. 제로 샷(Zero-shot) 프롬프팅

가장 기본적인 프롬프트 유형으로, 예시 없이 태스크 설명만 제공합니다:

```
영화 리뷰를 POSITIVE, NEUTRAL 또는 NEGATIVE로 분류하세요.
리뷰: "Her"는 AI가 계속 진화하면 인류가 나아갈 방향을 보여주는 불안한 연구입니다. 이런 걸작이 더 많았으면 좋겠어요.
감정:
```

### 2. 원샷(One-shot) & 퓨샷(Few-shot) 프롬프팅

모델에 하나 또는 여러 개의 예시를 제공하여 특정 패턴을 학습시키는 방법입니다:

```
다음 고객 피자 주문을 유효한 JSON으로 파싱하세요:

예시 1:
고객 요청: "치즈, 토마토 소스, 페퍼로니가 있는 작은 피자를 원해요."
JSON 응답:
{
  "size": "small",
  "type": "normal",
  "ingredients": [["cheese", "tomato sauce", "pepperoni"]]
}

예시 2:
고객 요청: "토마토 소스, 바질, 모짜렐라가 있는 큰 피자 하나 주세요."
{
  "size": "large",
  "type": "normal",
  "ingredients": [["tomato sauce", "basil", "mozzarella"]]
}

이제 이 주문을 파싱해주세요:
고객 요청: "첫 번째 반은 치즈와 모짜렐라, 다른 반은 토마토 소스, 햄, 파인애플이 있는 큰 피자를 원합니다."
JSON 응답:
```

퓨샷 프롬프팅에서는 다양한 예시를 포함하는 것이 중요합니다. 일반적으로 3-5개의 예시가 좋은 시작점이 됩니다.

### 3. 시스템, 역할, 컨텍스트 프롬프팅

#### 시스템 프롬프팅

모델의 전반적인 맥락과 목적을 설정합니다:

```
영화 리뷰를 positive, neutral, negative로 분류하세요. 라벨만 대문자로 반환하세요.
리뷰: "Her"는 AI가 계속 진화하면 인류가 나아갈 방향을 보여주는 불안한 연구입니다. 너무 불안해서 볼 수 없었어요.
감정:
```

#### 역할 프롬프팅

모델에 특정 역할을 부여합니다:

```
당신은 여행 가이드입니다. 제가 위치를 알려드리면 방문할 3곳을 추천해 주세요.
경우에 따라 방문하고 싶은 장소 유형도 알려드리겠습니다.
제 제안: "저는 암스테르담에 있고 박물관만 방문하고 싶습니다."
여행 추천:
```

유머러스한 스타일로 변경할 수도 있습니다:

```
당신은 여행 가이드입니다. 제가 위치를 알려드리면 유머러스한 스타일로 방문할 3곳을 추천해 주세요.
제 제안: "저는 맨해튼에 있습니다."
여행 추천:
```

#### 컨텍스트 프롬프팅

모델에 구체적인 배경 정보를 제공합니다:

```
컨텍스트: 당신은 80년대 레트로 아케이드 비디오 게임에 관한 블로그를 작성합니다.
글쓸 주제 3가지를 제안하고 각 주제에 대한 간략한 설명을 포함해주세요.
```

### 4. 단계별 접근법(Step-back) 프롬프팅

복잡한 문제를 해결할 때 먼저 일반적인 관련 질문을 고려한 후, 구체적인 작업에 접근하는 방법입니다:

```
# 첫 번째 프롬프트 (일반적인 접근)
인기 있는 1인칭 슈팅 액션 게임을 바탕으로, 1인칭 슈팅 비디오 게임의 도전적이고 매력적인 레벨 스토리라인에 기여하는 5가지 가상 핵심 설정은 무엇인가요?

# 응답 예시
1. 폐기된 군사 기지: 변형된 군인과 로봇이 배회하는 종말 후의 군사 단지로, 도전적인 화기 전투에 이상적입니다.
2. 사이버펑크 도시: 네온이 빛나는 미래형 도시 환경으로 고층 빌딩과 좁은 골목이 있고, 사이버네틱으로 강화된 적과 해킹 메커니즘이 특징입니다.
3. 외계인 우주선: 지구에 좌초된 거대한 외계 선박으로, 으스스한 복도, 무중력 구역 및 외계 생물체와의 만남이 있습니다.
4. 좀비 마을: 공격적인 좀비 무리에 의해 점령된 황량한 마을로, 근접 전투와 안전한 통로를 찾기 위한 퍼즐 해결이 특징입니다.
5. 수중 연구 시설: 물에 잠긴 심해 연구소로, 변형된 수중 생물이 가득하고 은밀함과 수중 탐험 기술이 필요합니다.

# 두 번째 프롬프트 (구체적인 작업)
컨텍스트: 1인칭 슈팅 비디오 게임을 위한 5가지 매력적인 테마:
1. 폐기된 군사 기지: 변형된 군인과 로봇이 배회하는 종말 후의 군사 단지로, 도전적인 화기 전투에 이상적입니다.
2. 사이버펑크 도시: 네온이 빛나는 미래형 도시 환경으로 고층 빌딩과 좁은 골목이 있고, 사이버네틱으로 강화된 적과 해킹 메커니즘이 특징입니다.
3. 외계인 우주선: 지구에 좌초된 거대한 외계 선박으로, 으스스한 복도, 무중력 구역 및 외계 생물체와의 만남이 있습니다.
4. 좀비 마을: 공격적인 좀비 무리에 의해 점령된 황량한 마을로, 근접 전투와 안전한 통로를 찾기 위한 퍼즐 해결이 특징입니다.
5. 수중 연구 시설: 물에 잠긴 심해 연구소로, 변형된 수중 생물이 가득하고 은밀함과 수중 탐험 기술이 필요합니다.

테마 중 하나를 선택하고 1인칭 슈팅 비디오 게임의 새로운 레벨에 대한 한 단락의 스토리라인을 작성하세요.
```

### 5. 사고 연쇄(Chain of Thought, CoT)

모델이 중간 추론 단계를 생성하도록 유도하여 더 정확한 답변을 얻는 기법입니다:

```
# 오류 있는 예시 (CoT 없음)
Q: 제가 3살일 때, 제 파트너는 제 나이의 3배였습니다. 지금 저는 20살입니다. 제 파트너는 몇 살인가요?
A: 63살

# CoT 적용한 예시
Q: 제가 3살일 때, 제 파트너는 제 나이의 3배였습니다. 지금 저는 20살입니다. 제 파트너는 몇 살인가요? 단계별로 생각해보세요.
A:
1. 제가 3살일 때, 제 나이는 3살이었습니다.
2. 그 당시 파트너의 나이는 제 나이의 3배였으므로, 파트너의 나이는 3 * 3 = 9살이었습니다.
3. 지금 저는 20살이므로, 제 나이는 20 - 3 = 17년 증가했습니다.
4. 파트너의 나이도 같은 기간 동안 17년 증가했을 것입니다.
5. 따라서, 파트너의 현재 나이는 9 + 17 = 26살입니다.
따라서, 제 파트너는 26살입니다.
```

CoT 프롬프팅 모범 사례:

- 추론 후에 답변을 배치해야 합니다.
- CoT와 자기 일관성 사용 시 최종 답변을 추론과 별도로 추출할 수 있어야 합니다.
- CoT 프롬프팅에는 temperature를 0으로 설정하세요.

### 6. 자기 일관성(Self-consistency)

여러 추론 경로를 생성하고 가장 일관된 답변을 선택하는 방법입니다:

```
# 이메일 분류 예시
EMAIL:
```

안녕하세요,
귀사의 웹사이트에 WordPress를 사용하고 계신 것을 보았습니다. 좋은 오픈 소스 콘텐츠 관리 시스템이죠. 저도 과거에 사용한 적이 있습니다. 많은 사용자 플러그인이 있고 설정하기도 쉽습니다.
연락 양식에서 버그를 발견했는데, 이름 필드를 선택할 때 발생합니다. 이름 필드에 텍스트를 입력하는 제 스크린샷을 참조하세요. JavaScript 경고 창이 나타납니다.
하지만 나머지는 좋은 웹사이트입니다. 즐겁게 읽었습니다. 웹사이트에 버그를 남겨두셔도 괜찮습니다. 더 흥미로운 내용을 읽을 수 있으니까요.
감사합니다.
해커 해리.

```

위 이메일을 IMPORTANT 또는 NOT IMPORTANT로 분류하세요. 단계별로 생각하고 이유를 설명해주세요.
```

이 프롬프트를 여러 번 실행하면 다양한 추론 경로와 결론을 얻을 수 있습니다. 대부분의 응답이 "IMPORTANT"로 분류한다면, 이것이 가장 일관된 답변입니다.

### 7. ReAct(사고 및 행동)

ReAct는 자연어 추론과 외부 도구(검색, 코드 인터프리터 등)를 결합한 프롬프팅 패러다임입니다:

```python
from langchain.agents import load_tools
from langchain.agents import initialize_agent
from langchain.agents import AgentType
from langchain.llms import VertexAI

prompt = "메탈리카 밴드 멤버들은 몇 명의 자녀를 두고 있나요?"
llm = VertexAI(temperature=0.1)
tools = load_tools(["serpapi"], llm=llm)
agent = initialize_agent(tools, llm, agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose=True)
agent.run(prompt)
```

출력 예시:

```
> 새로운 AgentExecutor 체인 시작...
메탈리카는 4명의 멤버가 있습니다.
Action: Search
Action Input: 제임스 헷필드 자녀 수는?
Observation: 세 명의 자녀
Thought: 1/4 메탈리카 밴드 멤버는 3명의 자녀가 있습니다.
Action: Search
Action Input: 라스 울리히 자녀 수는?
Observation: 3
Thought: 2/4 메탈리카 밴드 멤버는 6명의 자녀가 있습니다.
...
```

## 코드 프롬프팅 전략

### 코드 작성 프롬프트 예시

```
Bash에서 폴더 이름을 요청하는 코드 스니펫을 작성하세요. 그 다음 폴더의 내용을 가져와서 파일 이름 앞에 draft를 붙여 모든 파일의 이름을 바꿉니다.
```

결과:

```bash
#!/bin/bash
# 폴더 이름 요청
echo "폴더 이름을 입력하세요: "
read folder_name
# 폴더 존재 여부 확인
if [ ! -d "$folder_name" ]; then
  echo "폴더가 존재하지 않습니다."
  exit 1
fi
# 폴더 내 파일 목록 가져오기
files=( "$folder_name"/* )
# 각 파일의 이름을 "draft_"를 앞에 붙여 변경
for file in "${files[@]}"; do
  new_file_name="draft_$(basename "$file")"
  mv "$file" "$folder_name/$new_file_name"
done
echo "파일 이름이 성공적으로 변경되었습니다."
```

### 코드 디버깅 및 검토 프롬프트 예시

```
다음 Python 코드에 오류가 있습니다:

Traceback (most recent call last):
 File "/Users/leeboonstra/Documents/test_folder/rename_files.py", line 7, in <module>
 text = toUpperCase(prefix)
NameError: name 'toUpperCase' is not defined

무엇이 잘못되었는지 디버그하고 코드를 개선하는 방법을 설명해주세요.

import os
import shutil
folder_name = input("폴더 이름을 입력하세요: ")
prefix = input("파일 이름 앞에 추가할 문자열을 입력하세요: ")
text = toUpperCase(prefix)
if not os.path.isdir(folder_name):
 print("폴더가 존재하지 않습니다.")
 exit(1)
files = os.listdir(folder_name)
for file in files:
 new_filename = f"{text}_{file}"
shutil.move(os.path.join(folder_name, file),
os.path.joi(folder_name, new_file_name))
print("파일 이름이 성공적으로 변경되었습니다.")
```

## 프롬프트 엔지니어링 모범 사례

### 1. 단순하게 설계하기

프롬프트는 명확하고 이해하기 쉬워야 합니다:

```
# 개선 전:
저는 지금 뉴욕을 방문 중이고 멋진 장소에 대해 더 알고 싶습니다. 3살짜리 아이 둘이 있습니다. 휴가 중에 어디를 가야 할까요?

# 개선 후:
관광객을 위한 여행 가이드 역할을 해주세요. 3살 아이와 함께 뉴욕 맨해튼에서 방문하기 좋은 장소를 설명해주세요.
```

### 2. 출력에 대해 구체적으로 명시하기

```
# 좋은 예:
5대 비디오 게임 콘솔에 대한 3단락 블로그 포스트를 생성하세요. 블로그 포스트는 유익하고 매력적이어야 하며, 대화체로 작성되어야 합니다.

# 나쁜 예:
비디오 게임 콘솔에 대한 블로그 포스트를 생성하세요.
```

### 3. 제약보다 지시 사용하기

```
# 좋은 예:
상위 5개 비디오 게임 콘솔에 대한 1단락 블로그 포스트를 생성하세요. 콘솔, 제조사, 출시 연도, 총 판매량만 논의하세요.

# 나쁜 예:
상위 5개 비디오 게임 콘솔에 대한 1단락 블로그 포스트를 생성하세요. 비디오 게임 이름을 나열하지 마세요.
```

### 4. 프롬프트에 변수 사용하기

```
변수:
{city} = "암스테르담"

프롬프트:
당신은 여행 가이드입니다. 다음 도시에 대한 사실을 알려주세요: {city}
```

### 5. 프롬프트 시도 기록하기

프롬프트 개발 과정을 문서화하는 템플릿:

```
이름: [프롬프트 이름과 버전]
목표: [이 시도의 목표에 대한 한 문장 설명]
모델: [사용된 모델 이름과 버전]
Temperature: [0-1 사이 값]   Token Limit: [숫자]
Top-K: [숫자]   Top-P: [숫자]
프롬프트: [전체 프롬프트 내용]
출력: [출력 또는 여러 출력 작성]
```

## 자동 프롬프트 엔지니어링 (APE)

LLM에게 더 많은 프롬프트를 생성하도록 요청하고, 이를 평가, 수정하는 방식입니다:

```
# 1단계: 변형 생성을 위한 프롬프트 작성
우리는 밴드 머천다이즈 티셔츠 웹샵을 가지고 있고, 챗봇을 훈련시키기 위해 다양한 방식이 필요합니다: "S 사이즈 메탈리카 티셔츠 한 장 주세요." 같은 의미를 가지면서 10가지 다른 표현을 생성해주세요.

# 가능한 출력:
1. S 사이즈 메탈리카 티셔츠 구매하고 싶어요.
2. 작은 사이즈 메탈리카 티셔츠 하나 주문할 수 있을까요?
3. 메탈리카 S 사이즈 티셔츠 한 장 구매하려고 합니다.
...
```

## 스키마 활용하기

구조화된 입력과 출력을 위해 JSON 스키마를 활용할 수 있습니다:

```json
// 스키마 정의
{
 "type": "object",
 "properties": {
   "name": { "type": "string", "description": "제품 이름" },
   "category": { "type": "string", "description": "제품 카테고리" },
   "price": { "type": "number", "format": "float", "description": "제품 가격" },
   "features": {
     "type": "array",
     "items": { "type": "string" },
     "description": "제품의 주요 특징"
   },
   "release_date": { "type": "string", "format": "date", "description": "제품 출시일"}
 }
}

// 실제 데이터
{
 "name": "무선 헤드폰",
 "category": "전자제품",
 "price": 99.99,
 "features": ["노이즈 캔슬링", "블루투스 5.0", "20시간 배터리 수명"],
 "release_date": "2023-10-27"
}
```

## 결론

프롬프트 엔지니어링은 LLM의 잠재력을 최대한 활용하기 위한 반복적인 과정입니다. 다양한 기법을 실험하고, 결과를 문서화하며, 모델과 구성에 따라 프롬프트를 조정해 나가는 것이 중요합니다.

더 자세한 내용은 [Google의 프롬프팅 가이드](https://cloud.google.com/vertex-ai/generative-ai/docs/learn/prompts/introduction-prompt-design)나 [Chain of Thought와 ReAct 예제](https://github.com/GoogleCloudPlatform/generative-ai/blob/main/language/prompts/examples/chain_of_thought_react.ipynb)를 참조하세요.
